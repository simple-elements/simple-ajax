<!doctype html>
<html>
<head>
  <title>core-ajax</title>

  <script src="../bower_components/webcomponentsjs/webcomponents.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>
  <script src="../bower_components/simple-fixture/simple-fixture-mocha.js"></script>

  <link rel="import" href="../bower_components/polymer/polymer.html">
  <link rel="import" href="../bower_components/simple-fixture/simple-fixture.html">
  <link rel="import" href="../simple-ajax.html">
</head>
<body>
  <simple-fixture id="SimpleGet">
    <template>
      <simple-ajax url="/responds_to_get_with_json"></simple-ajax>
    </template>
  </simple-fixture>
  <simple-fixture id="SimplePost">
    <template>
      <simple-ajax method="POST"
                   url="/responds_to_post_with_json"></simple-ajax>
    </template>
  </simple-fixture>
  <script>
describe('<simple-ajax>', function () {
  var jsonResponseHeaders = {
    'Content-Type': 'application/json'
  };
  var simpleAjax;
  var server;

  beforeEach(function () {
    server = sinon.fakeServer.create();
    server.respondWith(
      'GET',
      '/responds_to_get_with_json',
      [
        200,
        jsonResponseHeaders,
        '{"success":true}'
      ]
    );

    server.respondWith(
      'POST',
      '/responds_to_post_with_json',
      [
        200,
        jsonResponseHeaders,
        '{"post_success":true}'
      ]
    );

    simpleAjax = fixture('SimpleGet');
  });

  afterEach(function () {
    server.restore();
  });

  it('generates simple-request elements based on a declarative configuration', function () {
    var request;

    request = simpleAjax.generateRequest();

    expect(request.xhr.method).to.be.equal('GET');

    simpleAjax.method = 'POST';
    simpleAjax.url = '/responds_to_post_with_json';

    request = simpleAjax.generateRequest();

    expect(request.xhr.method).to.be.equal('POST');
  });

  it('comes with sane defaults to support simple GET requests for JSON', function (done) {
    var request = simpleAjax.generateRequest();

    request.completes.then(function (response) {
      expect(response).to.be.ok;
      expect(response).to.be.an('object');
      expect(response.success).to.be.equal(true);
      done();
    }).catch(function (error) {
      done(error);
    });

    server.respond();
  });

  describe('when making POST requests', function () {
    beforeEach(function () {
      simpleAjax = fixture('SimplePost');
    });

    it('it POSTs the value of the `body` attribute', function () {
      var requestBody = JSON.stringify({foo: 'bar'});

      simpleAjax.body = requestBody;

      simpleAjax.generateRequest();

      expect(server.requests[0]).to.be.ok;
      expect(server.requests[0].requestBody).to.be.equal(requestBody);
    });
  });
});
  </script>

</body>
</html>
