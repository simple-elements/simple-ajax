<!doctype html>
<html>
<head>
  <title>core-ajax</title>

  <script src="../bower_components/webcomponentsjs/webcomponents.js"></script>
  <script src="../bower_components/web-component-tester/browser.js"></script>

  <link rel="import" href="../bower_components/polymer/polymer.html">
  <link rel="import" href="../test-fixture.html">
  <link rel="import" href="../simple-ajax.html">
</head>
<body>
  <test-fixture>
    <template>
      <simple-ajax  id="SimpleGet"
                    url="/responds_to_get_with_json"></simple-ajax>
      <simple-ajax  id="SimplePost"
                    method="POST"
                    url="/responds_to_post_with_json"></simple-ajax>
    </template>
  </test-fixture>
  <script>
describe('<simple-ajax>', function () {
  var jsonResponseHeaders = {
    'Content-Type': 'application/json'
  };
  var testFixture = document.getElementsByTagName('test-fixture')[0];
  var simpleAjax;
  var server;

  beforeEach(function () {
    testFixture.create();
    server = sinon.fakeServer.create();
    server.respondWith(
      'GET',
      '/responds_to_get_with_json',
      [
        200,
        jsonResponseHeaders,
        '{"success":true}'
      ]
    );

    server.respondWith(
      'POST',
      '/responds_to_post_with_json',
      [
        200,
        jsonResponseHeaders,
        '{"post_success":true}'
      ]
    );

    simpleAjax = document.getElementById('SimpleGet');
  });

  afterEach(function () {
    testFixture.restore();
    server.restore();
  });

  it('generates simple-request elements based on a declarative configuration', function () {
    var request;

    request = simpleAjax.generateRequest();

    expect(request.xhr.method).to.be.equal('GET');

    simpleAjax.method = 'POST';
    simpleAjax.url = '/responds_to_post_with_json';

    request = simpleAjax.generateRequest();

    expect(request.xhr.method).to.be.equal('POST');
  });

  it('comes with sane defaults to support simple GET requests for JSON', function (done) {
    var request = simpleAjax.generateRequest();

    request.completes.then(function (response) {
      expect(response).to.be.ok;
      expect(response).to.be.an('object');
      expect(response.success).to.be.equal(true);
      done();
    }).catch(function (error) {
      done(error);
    });

    server.respond();
  });

  /*
  describe('when data needs to be POSTed', function () {
    beforeEach(function () {
      simpleAjax = document.getElementById('SimplePost');
    });

    it('automatically stringifies objects', function (done) {
      var requestBody = { foo: 'bar' };
      var request;

      simpleAjax.send(requestBody).then(function (response) {
        expect(response).to.be.ok;
        expect(response).to.be.an('object');
        expect(response.post_success).to.be.equal(true);
        expect(request.requestBody).to.be.equal(JSON.stringify(requestBody));
        done();
      }).catch(function (error) {
        done(error);
      });

      request = server.requests[0];

      server.respond();
    });
  });
  */

  // TODO: Post form data
});
  </script>

</body>
</html>
