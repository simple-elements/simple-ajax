<link rel="import" href="simple-request.html">
<script>
(function () {
  var Polymerfill = {
    configure: function (target) {
      var defaults = target.defaults || {};

      Object.keys(defaults).forEach(function (key) {
        var value = defaults[key];

        if (Array.isArray(value)) {
          value = value.slice();
        } else if (value instanceof Object) {
          value = Object.create(value);
        }

        if (target[key] === undefined) {
          target[key] = value;
        }
      });
    }
  };

  Polymer({
    is: 'simple-ajax',

    published: {
      url: String,
      method: String,
      headers: Object,
      body: String,
      async: Boolean,
      handleas: String,
      auto: Boolean,
      withcredentials: Boolean,
      activeRequests: {
        type: Number,
        readOnly: true
      }
    },

    defaults: {
      url: '',
      method: 'GET',
      handleas: 'json',
      body: undefined,
      async: true,
      headers: {},
      auto: false,
      withcredentials: false,
      activeRequests: 0
    },

    toAjaxOptions: function () {
      return {
        url: this.url,
        method: this.method,
        headers: Object.create(this.headers),
        body: this.body,
        async: this.async,
        handleAs: this.handleas,
        withCredentials: this.withcredentials
      }
    },

    ready: function () {
      Polymerfill.configure(this);
    },

    generateRequest: function () {
      var request = document.createElement('simple-request');
      var removeRequestElement = function () {
        try {
          this.localDom.removeChild(request);
        } catch(e) {}
      }.bind(this);

      this.localDom.appendChild(request);

      request.completes.then(removeRequestElement, removeRequestElement);

      request.send(this.toAjaxOptions());

      return request;
    }
  });
})();
</script>
